---
title: "ç»„é—´æ¯”è¾ƒ_è®¤çŸ¥åˆ†é¡¹"
output: html_notebook
---

```{r}
rm(list = ls())
library(readxl)
library(writexl)
library(dplyr)
library(readxl)
library(ggpubr)
library(car)
library(ggplot2)
library(psych)
library(rstatix)
library(naniar)
library(clinfun)
library(tidyr)
library(purrr)
library(stats)


options(scipen = 999)
original_path <- "/Users/qiuyuyue/Documents/MRI/data/SuStaIn/pureAD_æœ€ç»ˆç‰ˆ2_MCMC100000/vMRI_with_SuStaIn_S3to5_with_WMH_APOE_multiCOG.xlsx"
df <- read_excel(original_path)
df$ml_subtype <- df$SuStaIn_S4_subtype + 1
df$ml_stage <- df$SuStaIn_S4_stage
```


### Stage & MMSE
```{r}
cor.test(df$ml_stage, df$closet_MMSE, method = "spearman", use = "complete.obs")
df$ml_stage <- as.numeric(as.character(df$ml_stage))
jonckheere.test(df$closet_MMSE, df$ml_stage, alternative = "decreasing")

ggplot(df, aes(x = factor(ml_stage), y = closet_MMSE)) +
  geom_boxplot(fill = "skyblue") +
  labs(x = "SuStaIn Stage", y = "MMSE") +
  theme_minimal() +
  scale_x_discrete(breaks = as.character(seq(0, 50, by = 5))) +
  annotate("text", 
           x = 47, y = 31.5, 
           label = paste0("Spearman rho = -0.56, p < 0.0001\nJonckheere p < 0.0001"), 
           hjust = 1, vjust = 1.2, size = 3.5)
sum(complete.cases(df$ml_stage, df$closet_MMSE))
```


### æ•°æ®é¢„å¤„ç†
```{r}
df$ml_subtype <- as.factor(df$ml_subtype)

df <- df %>%
  mutate(moca_attention_calculation = moca_attention + moca_calculation) %>%
  select(-moca_attention, -moca_calculation)
df <- df %>%
  mutate(moca_executive_visuospatial = moca_executive + moca_visuospatial) %>%
  select(-moca_executive, -moca_visuospatial)
df <- df %>%
  mutate(mmse_language_construction = mmse_do + mmse_repeat + mmse_name + mmse_read + mmse_write + mmse_draw) %>%
  select(-mmse_do, -mmse_repeat, -mmse_name, -mmse_read, -mmse_write, -mmse_draw)

# åˆ›å»º MMSE å­é¡¹å‘½åæ˜ å°„
name_map_mmse <- c(
  mmse_orientation = "MMSE Orientation",
  mmse_memory = "MMSE Immediate Recall",
  mmse_recall = "MMSE Delayed Recall",
  mmse_calculate = "MMSE Serial Subtraction",
  mmse_language_construction = "MMSE Language/Construction"
)
# MoCA å­é¡¹å‘½åæ˜ å°„
name_map_moca <- c(
  moca_executive_visuospatial = "MoCA Executive",
  moca_naming = "MoCA Naming",
  moca_attention_calculation = "MoCA Attention",
  moca_language = "MoCA Language",
  moca_abstraction = "MoCA Abstraction",
  moca_recall = "MoCA Delayed Recall",
  moca_recall_cue1 = "MoCA Cued Recall (Category)",
  moca_recall_cue2 = "MoCA Cued Recall (Recognition)",
  moca_orientation = "MoCA Orientation"
)
# æ›¿æ¢åˆ—å
library(dplyr)
name_map_all <- c(name_map_mmse, name_map_moca)
colnames(df) <- ifelse(
  colnames(df) %in% names(name_map_all),
  name_map_all[colnames(df)],
  colnames(df)
)

# è½¬åŒ–æˆæœ‰åºåˆ†ç±»å˜é‡
target_cols_mmse <- unname(name_map_mmse)
df[target_cols_mmse] <- lapply(df[target_cols_mmse], function(x) {
  factor(x, levels = sort(unique(na.omit(x))), ordered = TRUE)
})
target_cols_moca <- unname(name_map_moca)
df[target_cols_moca] <- lapply(df[target_cols_moca], function(x) {
  factor(x, levels = sort(unique(na.omit(x))), ordered = TRUE)
})

# è®¤çŸ¥ç»¼åˆ
cols_to_convert <- c(
  "multiCOG_ActionImitation",
  "multiCOG_BlockDesign",
  "multiCOG_CopyTest",
  "multiCOG_Repetition",
  "multiCOG_Naming"
)
for (col in cols_to_convert) {
  df[[col]] <- factor(df[[col]],
                      levels = c("0(æ­£å¸¸)", "1(å¼‚å¸¸(è½»))", "2(å¼‚å¸¸(é‡))"),
                      labels = c("normal", "mild", "severe"),
                      ordered = TRUE)
}
df$multiCOG_ClockDrawing <- factor(df$multiCOG_ClockDrawing,
                                   levels = c(0, 1, 2, 3),
                                   ordered = TRUE)

# åˆå¹¶å˜é‡åˆ—è¡¨
# å®šä¹‰åˆ—åæ›¿æ¢æ˜ å°„
name_map_rzzh <- c(
  "åŠ¨ç‰©åˆ—å_Z" = "Animal Naming (Z)",
  "æ•°å­—ç¬¦å·_Z" = "Digit Symbol (Z)",
  "æ¥é¾™Aæ—¶é—´_Z" = "Trail Making Time (Z)",
  "Reyä¸´æ‘¹_Z" = "Rey Copy (Z)",
  "Reyå›å¿†_Z" = "Rey Recall (Z)",
  "æƒ…æ™¯è®°å¿†_Z" = "Logical Memory (Z)",
  "ç›¸ä¼¼æ€§_Z" = "Similarities (Z)",
  "è®¡ç®—_Z" = "Calculation (Z)",
  
  "avlt1" = "AVLT Trial 1",
  "avlt2" = "AVLT Trial 2",
  "avlt3" = "AVLT Trial 3",
  "avlt4" = "AVLT Trial 4",
  "avlt5" = "AVLT Trial 5",
  "avlt6" = "AVLT Trial 6",
  "avlti" = "AVLT-i",
  "avltt" = "AVLT-t",
  "å†è®¤å‡»ä¸­" = "AVLT-hit",
  
  "multiCOG_ClockDrawing" = "Clock Drawing",
  "multiCOG_ActionImitation" = "Action Imitation",
  "multiCOG_BlockDesign" = "Block Design",
  "multiCOG_CopyTest" = "Copying Test",
  "multiCOG_Repetition" = "Sentence Repetition",
  "multiCOG_Naming" = "Naming"
)
# æ›¿æ¢åˆ—å
names(df) <- ifelse(names(df) %in% names(name_map_rzzh),
                    name_map_rzzh[names(df)],
                    names(df))

```


### MMSEåˆ†é¡¹
```{r}
### MMSE åˆ†é¡¹ Kruskal-Wallis æ£€éªŒ ###
# å˜é‡å: mmse_kruskal_df
mmse_kruskal_results <- lapply(target_cols_mmse, function(col) {
  test <- kruskal.test(as.formula(paste0("`", col, "` ~ ml_subtype")), data = df)
  data.frame(Variable = col, p_value = test$p.value)
})
mmse_kruskal_df <- bind_rows(mmse_kruskal_results) %>% arrange(p_value)
mmse_kruskal_df <- mmse_kruskal_df %>%
  mutate(p_adjust_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_adjust_fdr)
# print(mmse_kruskal_df) # æ‰“å°ç»“æœ

### MMSE åˆ†é¡¹ Dunnâ€™s test ###
# å˜é‡å: mmse_dunn_sig_results
mmse_sig_vars <- mmse_kruskal_df %>% filter(p_adjust_fdr < 0.05) %>% pull(Variable)

mmse_dunn_sig_results <- purrr::map_dfr(mmse_sig_vars, function(var) {
  formula_str <- paste0("`", var, "` ~ ml_subtype")
  df %>%
    dunn_test(as.formula(formula_str), p.adjust.method = "fdr") %>%
    mutate(Variable = var)
})
# print(mmse_dunn_sig_results, n=24) # æ‰“å°ç»“æœ

### MMSE ç»˜å›¾æ•°æ®å‡†å¤‡ ###
# å˜é‡å: mmse_dunn_plot_data
mmse_dunn_plot_data <- mmse_dunn_sig_results %>%
  filter(p.adj < 0.05) %>% 
  select(
    Variable, 
    group1, 
    group2, 
    p.adj.signif,
    p.adj 
  ) %>%
  rename(Cognitive_Variable = Variable) %>%
  # y.position çš„è®¡ç®—éœ€è¦ä¾èµ– df_longï¼Œè¿™é‡Œå…ˆç”¨ä¸€ä¸ªé»˜è®¤å€¼
  mutate(y.position = 5.25) 
print(mmse_dunn_plot_data) # æ‰“å°ç»“æœ
```


### MoCAåˆ†é¡¹
```{r}
### MoCA åˆ†é¡¹ Kruskal-Wallis æ£€éªŒ ###
# å˜é‡å: moca_kruskal_df
moca_kruskal_results <- lapply(target_cols_moca, function(col) {
  test <- kruskal.test(as.formula(paste0("`", col, "` ~ ml_subtype")), data = df)
  data.frame(Variable = col, p_value = test$p.value)
})
moca_kruskal_df <- bind_rows(moca_kruskal_results) %>% arrange(p_value)
moca_kruskal_df <- moca_kruskal_df %>%
  mutate(p_adjust_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_adjust_fdr)
# print(moca_kruskal_df) # æ‰“å°ç»“æœ

### MoCA åˆ†é¡¹ Dunnâ€™s test ###
# å˜é‡å: moca_dunn_sig_results
moca_sig_vars <- moca_kruskal_df %>% filter(p_adjust_fdr < 0.05) %>% pull(Variable)

moca_dunn_sig_results <- purrr::map_dfr(moca_sig_vars, function(var) {
  df %>%
    dunn_test(as.formula(paste0("`", var, "` ~ ml_subtype")),
              p.adjust.method = "fdr") %>%
    mutate(Variable = var)
})
# print(moca_dunn_sig_results, n=30) # æ‰“å°ç»“æœ

### MoCA ç»˜å›¾æ•°æ®å‡†å¤‡ ###
moca_dunn_plot_data <- moca_dunn_sig_results %>%
  filter(p.adj < 0.05) %>% 
  select(
    Variable, 
    group1, 
    group2, 
    p.adj.signif,
    p.adj 
  ) %>%
  rename(Cognitive_Variable = Variable) %>%
  # y.position çš„è®¡ç®—éœ€è¦ä¾èµ– df_longï¼Œè¿™é‡Œå…ˆç”¨ä¸€ä¸ªé»˜è®¤å€¼
  mutate(y.position = 5.25) 
print(moca_dunn_plot_data) # æ‰“å°ç»“æœ

```

### è®¤çŸ¥ç»¼åˆ & AVLT
```{r}
continuous_vars <- c(
  "AVLT Trial 1", "AVLT Trial 2", "AVLT Trial 3", "AVLT Trial 4", "AVLT Trial 5", "AVLT Trial 6",
  "AVLT-i", "AVLT-t", "AVLT-hit",
  "Animal Naming (Z)", "Digit Symbol (Z)", "Trail Making Time (Z)", "Rey Copy (Z)",
  "Rey Recall (Z)", "Logical Memory (Z)", "Similarities (Z)", "Calculation (Z)"
)
ordinal_vars <- c(
  "Clock Drawing", "Action Imitation", "Block Design", "Copying Test",
  "Sentence Repetition", "Naming")
all_vars <- unname(name_map_rzzh)

# æ‰¹é‡ Kruskal-Wallis æ£€éªŒ (ä½¿ç”¨ all_vars åˆ—è¡¨)
avlt_kruskal_results <- map_dfr(all_vars, function(col) {
  test_data <- df %>% select(ml_subtype, !!sym(col)) %>% na.omit()
  formula_text <- paste0("`", col, "` ~ ml_subtype") 
  test <- kruskal.test(as.formula(formula_text), data = test_data)
  data.frame(
    Variable = col,
    p_value = test$p.value
  )
})

# FDR æ ¡æ­£å¹¶ç»Ÿä¸€å˜é‡å
avlt_kruskal_df <- avlt_kruskal_results %>%
  mutate(p_adjust_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_adjust_fdr)
# print(avlt_kruskal_df) # æ‰“å°ç»“æœ

# -----------------------------------------------------------
### è®¤çŸ¥ç»¼åˆ & AVLT Dunnâ€™s test #### å˜é‡å: avlt_dunn_sig_results
# -----------------------------------------------------------
library(rstatix)
# ç­›é€‰ FDR æ ¡æ­£åæ˜¾è‘—çš„å˜é‡ (ç»Ÿä¸€ä½¿ç”¨ p_adjust_fdr)
avlt_sig_vars <- avlt_kruskal_df %>% filter(p_adjust_fdr < 0.05) %>% pull(Variable)

# Dunn æ£€éªŒï¼ˆFDRæ ¡æ­£ï¼‰ï¼Œå¾ªç¯æ‰€æœ‰æ˜¾è‘—å˜é‡
avlt_dunn_sig_results <- purrr::map_dfr(avlt_sig_vars, function(var) {
  test_data <- df %>% select(ml_subtype, !!sym(var)) %>% na.omit()
  formula_str <- paste0("`", var, "` ~ ml_subtype")
  dunn_out <- dunn_test(test_data, formula = as.formula(formula_str), 
                        p.adjust.method = "fdr") %>%
    mutate(Variable = var)
  return(dunn_out)
})
# print(avlt_dunn_sig_results, n=60) # æ‰“å°ç»“æœ

# -----------------------------------------------------------
### è®¤çŸ¥ç»¼åˆ & AVLT ç»˜å›¾æ•°æ®å‡†å¤‡ #### å˜é‡å: avlt_dunn_plot_data
# -----------------------------------------------------------
avlt_dunn_plot_data <- avlt_dunn_sig_results %>%
  filter(p.adj < 0.05) %>% 
  select(
    Variable, 
    group1, 
    group2, 
    p.adj.signif,
    p.adj 
  ) %>%
  rename(Cognitive_Variable = Variable) %>%
  # y.position çš„è®¡ç®—éœ€è¦ä¾èµ– df_longï¼Œè¿™é‡Œå…ˆç”¨ä¸€ä¸ªé»˜è®¤å€¼ (ä¸ MoCA/MMSE ä¿æŒä¸€è‡´)
  mutate(y.position = 5.25) 

print(avlt_dunn_plot_data) # æ‰“å°ç»“æœ
```




### æœ€ç»ˆæ•°æ®åˆå¹¶
```{r}
# -----------------------------------------------------------
# 1. ç»Ÿä¸€æ˜¾è‘—æ€§æ•°æ®çš„ y.position è®¡ç®—å‡½æ•°
# -----------------------------------------------------------
prepare_plot_data <- function(df_long, dunn_results_raw) {
  # 1.1 è®¡ç®—æ¯ä¸ªå˜é‡çš„æœ€å¤§åˆ†æ•°
  max_scores <- df_long %>%
    group_by(Cognitive_Variable) %>%
    summarise(max_score = max(Score, na.rm = TRUE)) %>%
    ungroup()
  
  # 1.2 å‡†å¤‡ç»˜å›¾æ•°æ®å¹¶åŠ¨æ€è®¡ç®— y.position
  plot_data <- dunn_results_raw %>%
    filter(p.adj < 0.05) %>%
    select(Variable, group1, group2, p.adj.signif, p.adj) %>%
    rename(Cognitive_Variable = Variable) %>%
    
    # å…³è”æœ€å¤§åˆ†æ•°
    left_join(max_scores, by = "Cognitive_Variable") %>%
    
    # åˆ†ç»„è®¡ç®— y.position (åŒä¸€å˜é‡å†…çš„æ¯”è¾ƒè¦å †å )
    group_by(Cognitive_Variable) %>%
    mutate(
      # y.position = MaxScore * (åŸºç¡€é«˜åº¦ + å †å å¢é‡ * æ¯”è¾ƒåºå·)
      y.position = max_score * (1.2 + 0.10 * (row_number() - 1))
    ) %>%
    ungroup() %>%
    select(-max_score)
  
  return(plot_data)
}

# -----------------------------------------------------------
# 2. MMSE æ•°æ®å‡†å¤‡
# -----------------------------------------------------------
# ç»˜å›¾å‰å¯¹ MMSE æ•°æ®çš„å¤„ç† (ä¿®æ­£ç±»å‹é”™è¯¯)
mmse_sig_vars <- mmse_kruskal_df %>% filter(p_adjust_fdr < 0.05) %>% pull(Variable)

df_mmse_plot <- df %>%
  select(all_of(mmse_sig_vars), ml_subtype) %>%
  mutate(across(all_of(mmse_sig_vars), as.numeric)) # å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å€¼å‹

mmse_df_long <- df_mmse_plot %>%
  mutate(ml_subtype = factor(ml_subtype, levels = c("1", "2", "3", "4"))) %>%
  pivot_longer(
    cols = -ml_subtype,
    names_to = "Cognitive_Variable",
    values_to = "Score"
  )

# é‡æ–°è®¡ç®— mmse_dunn_plot_data ä¸­çš„ y.position (åŠ¨æ€è®¡ç®—)
mmse_dunn_plot_data <- prepare_plot_data(mmse_df_long, mmse_dunn_sig_results)


# -----------------------------------------------------------
# 3. MoCA æ•°æ®å‡†å¤‡
# -----------------------------------------------------------
moca_sig_vars <- moca_kruskal_df %>% filter(p_adjust_fdr < 0.05) %>% pull(Variable)

df_moca_plot <- df %>%
  select(all_of(moca_sig_vars), ml_subtype) %>%
  mutate(across(all_of(moca_sig_vars), as.numeric)) 

moca_df_long <- df_moca_plot %>%
  mutate(ml_subtype = factor(ml_subtype, levels = c("1", "2", "3", "4"))) %>%
  pivot_longer(
    cols = -ml_subtype,
    names_to = "Cognitive_Variable",
    values_to = "Score"
  )

# é‡æ–°è®¡ç®— moca_dunn_plot_data ä¸­çš„ y.position (åŠ¨æ€è®¡ç®—)
moca_dunn_plot_data <- prepare_plot_data(moca_df_long, moca_dunn_sig_results)

# -----------------------------------------------------------
# 4. AVLT/è®¤çŸ¥ç»¼åˆæ•°æ®å‡†å¤‡
# -----------------------------------------------------------
# æ³¨æ„ï¼šæˆ‘ä»¬å¿…é¡»åŒ…å«æ‰€æœ‰æ˜¾è‘—å˜é‡ï¼ŒåŒ…æ‹¬ Z-scores å’Œå¯èƒ½çš„åºæ•°å˜é‡
df_avlt_plot <- df %>%
  select(all_of(avlt_sig_vars), ml_subtype)
# å¯¹äºæœ‰åºå› å­ (Ordered Factor)ï¼Œas.numeric ä¼šå°†å…¶è½¬æ¢ä¸º 1, 2, 3... çš„æ•´æ•°ç­‰çº§
df_avlt_plot <- df_avlt_plot %>%
  mutate(across(all_of(avlt_sig_vars), as.numeric))

avlt_df_long <- df_avlt_plot %>%
  mutate(ml_subtype = factor(ml_subtype, levels = c("1", "2", "3", "4"))) %>%
  pivot_longer(
    cols = -ml_subtype,
    names_to = "Cognitive_Variable",
    values_to = "Score"
  )

max_scores_avlt <- avlt_df_long %>%
  group_by(Cognitive_Variable) %>%
  summarise(max_score = max(Score, na.rm = TRUE)) %>%
  ungroup()

# 2. å‡†å¤‡ç»˜å›¾æ•°æ®å¹¶è®¡ç®— y.position
avlt_dunn_plot_data <- avlt_dunn_sig_results %>%
  filter(p.adj < 0.05) %>%
  select(
    Variable, 
    group1, 
    group2, 
    p.adj.signif, 
    p.adj 
  ) %>%
  rename(Cognitive_Variable = Variable) %>%
  # åŠ å…¥ max_score
  left_join(max_scores_avlt, by = "Cognitive_Variable") %>%
  # åŠ¨æ€è®¡ç®— y.position
  group_by(Cognitive_Variable) %>%
  mutate(
    # è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ å±‚æ˜¾è‘—æ€§è¿çº¿ (0, 1, 2...)
    step_index = row_number() - 1,
    y.position = case_when(
      # ã€ç‰¹åˆ¤ 1ã€‘: é’ˆå¯¹ Rey Copy (Z) è¿™ç§èŒƒå›´å¤§ä½†æœ€å¤§å€¼å°çš„å˜é‡
      # max_score + èµ·å§‹ç¼“å†²(2) + (å±‚æ•° * æ­¥é•¿(3))
      # æ³¨æ„ï¼šè¿™é‡Œçš„ 3 æ˜¯æ­¥é•¿ï¼Œå¦‚æœè§‰å¾—çº¿è¿˜æ˜¯æŒ¤ï¼Œå°±æŠŠ 3 æ”¹æˆ 4 æˆ– 5
      Cognitive_Variable == "Rey Copy (Z)" ~ max_score + 2 + (step_index * 3),
      
      # ã€ç‰¹åˆ¤ 2ã€‘: é’ˆå¯¹å…¶ä»– Z-score æˆ–æœ€å¤§å€¼è¾ƒå°çš„å˜é‡ (æ¯”å¦‚ < 5)
      # ç­–ç•¥ï¼šåŠ æ³•æ¨¡å¼ï¼Œä½†æ­¥é•¿å°ä¸€ç‚¹
      max_score <= 8 ~ max_score * (1.3 + 0.2*step_index),
      
      # ã€é»˜è®¤ã€‘: é’ˆå¯¹ AVLT ç­‰å¤§æ•°å€¼å˜é‡
      # ç­–ç•¥ï¼šä¹˜æ³•æ¨¡å¼
      TRUE ~ max_score + 0.2 + step_index*1
    )
  ) %>%
  ungroup() %>%
  select(-max_score, -step_index) # æ¸…ç†ä¸­é—´å˜é‡


# -----------------------------------------------------------
# 5. æœ€ç»ˆåˆå¹¶
# -----------------------------------------------------------

# åˆå¹¶æ‰€æœ‰é•¿æ ¼å¼æ•°æ®
combined_df_long_all <- bind_rows(mmse_df_long, moca_df_long, avlt_df_long)

# åˆå¹¶æ‰€æœ‰æ˜¾è‘—æ€§æ•°æ®
combined_dunn_plot_data_all <- bind_rows(mmse_dunn_plot_data, moca_dunn_plot_data, avlt_dunn_plot_data)

# ç¡®å®šæœ€ç»ˆå˜é‡é¡ºåº (ä¿æŒä¸å˜)
ordered_vars <- c(
  "MMSE Serial Subtraction", "MoCA Executive", "MoCA Attention", 
  "Trail Making Time (Z)", "Digit Symbol (Z)", "Calculation (Z)", "Clock Drawing", "Copying Test", "Rey Copy (Z)", 
  "MMSE Delayed Recall", "MoCA Delayed Recall", "MoCA Cued Recall (Category)", "AVLT Trial 4", "AVLT Trial 6", 
  "MoCA Naming" 
)

# åº”ç”¨é¡ºåº
combined_df_long_all$Cognitive_Variable <- factor(
  combined_df_long_all$Cognitive_Variable, 
  levels = ordered_vars[ordered_vars %in% unique(combined_df_long_all$Cognitive_Variable)]
)
combined_dunn_plot_data_all$Cognitive_Variable <- factor(
  combined_dunn_plot_data_all$Cognitive_Variable, 
  levels = ordered_vars[ordered_vars %in% unique(combined_dunn_plot_data_all$Cognitive_Variable)]
)

# æ‰“å°æ–°çš„æ˜¾è‘—æ€§æ•°æ®ï¼Œç¡®ä¿ y.position æ˜¯åŠ¨æ€å †å çš„
print(combined_dunn_plot_data_all, n = 30)
```

### è®¾ç½®Figureså˜é‡
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)
library(ggpubr)
library(ggh4x)

# å®šä¹‰å“ªäº›å˜é‡éœ€è¦ç”»æˆçº¯ç®±å‹å›¾
box_only_vars <- c(
  "Trail Making Time (Z)", 
  "Digit Symbol (Z)", 
  "Calculation (Z)", 
  "Rey Copy (Z)", 
  "AVLT Trial 4", 
  "AVLT Trial 6"
)
vars_ordered <- levels(combined_df_long_all$Cognitive_Variable)
label_data <- data.frame(
  Cognitive_Variable = factor(vars_ordered, levels = vars_ordered), # ç¡®ä¿åˆ†é¢å¯¹åº”
  Label = LETTERS[1:length(vars_ordered)]                           # ç”Ÿæˆ A, B, C...
)
```

```{r}
final_combined_plot <- ggplot(combined_df_long_all, aes(x = ml_subtype, y = Score, fill = ml_subtype)) +
  
  # --- (ä¸­é—´çš„ geom_violin, boxplot, jitter, stat_pvalue_manual ä»£ç ä¿æŒä¸å˜) ---
  geom_violin(data = . %>% filter(!Cognitive_Variable %in% box_only_vars), trim = FALSE, color = "gray30", alpha = 0.8) +
  geom_boxplot(data = . %>% filter(!Cognitive_Variable %in% box_only_vars), width = 0.2, outlier.shape = NA, color = "gray30", fill = "white") +
  geom_boxplot(data = . %>% filter(Cognitive_Variable %in% box_only_vars), width = 0.7, outlier.shape = NA, color = "gray30", alpha = 0.8) +
  geom_jitter(width = 0.15, size = 0.6, alpha = 0.5) +
  stat_pvalue_manual(combined_dunn_plot_data_all, label = "p.adj.signif", y.position = "y.position", step.increase = 0, tip.length = 0.01, size = 2.5, bracket.size = 0.4, hide.ns = TRUE) +
  
  facet_wrap(~ Cognitive_Variable, scales = "free_y", ncol = 4) + 
  scale_fill_manual(values = c("#374E55FF", "#DF8F44FF", "#00A1D5FF", "#B24745FF")) +
  
  # --- ğŸ”¥ğŸ”¥ ä¿®æ”¹ç‚¹ 1ï¼šgeom_text çš„ä½ç½®è°ƒæ•´ ğŸ”¥ğŸ”¥ ---
  geom_text(
    data = label_data,
    aes(label = Label),
    x = -Inf,               # æ”¹ä¸º -Infï¼Œè®©å®ƒè‡ªåŠ¨è´´åˆ°æœ€å·¦è¾¹çš„è¾¹ç¼˜
    y = Inf,                # y = Inf ä»£è¡¨è´´ç€å›¾çš„é¡¶ç«¯
    hjust = 1.5,             # è´Ÿæ•°ä»£è¡¨å‘å³ç¼©è¿›ä¸€ç‚¹ç‚¹ï¼Œä¸è¦ç´§è´´è¾¹æ¡†
    vjust = -0.73,             # ğŸ”¥ å…³é”®ï¼šè´Ÿæ•°ä»£è¡¨â€œå‘ä¸Šâ€ç§»åŠ¨ï¼ŒæŠŠå®ƒæ¨åˆ°æ ‡é¢˜è¡Œçš„é«˜åº¦
    size = 3,               # å­—ä½“ç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹
    fontface = "bold",
    inherit.aes = FALSE
  ) +

  theme_minimal(base_size = 10) +
  theme(
    legend.position = "none",
    
    # --- ğŸ”¥ğŸ”¥ ä¿®æ”¹ç‚¹ 2ï¼šç§»é™¤æ ‡é¢˜è¡Œçš„èƒŒæ™¯é¢œè‰² ğŸ”¥ğŸ”¥ ---
    # å¿…é¡»æŠŠèƒŒæ™¯è®¾ä¸ºé€æ˜æˆ–ç©ºç™½ï¼Œå¦åˆ™å®ƒæ°¸è¿œä¼šç›–ä½ä½ çš„ geom_text
    strip.background = element_blank(), 
    
    strip.text = element_text(face = "bold", size = 8, hjust = 0.5),
    axis.text = element_text(size = 8),
    axis.title = element_text(size = 9),
    panel.grid.major.x = element_blank(),
    plot.title = element_text(face = "bold", size = 8, hjust = 0.5),
    
    # --- ğŸ”¥ğŸ”¥ ä¿®æ”¹ç‚¹ 3ï¼šå¢åŠ é¡¶éƒ¨è¾¹è· ğŸ”¥ğŸ”¥ ---
    # å› ä¸ºæ–‡å­—è¢«æ¨åˆ°äº†å›¾å¤–é¢ï¼Œå¯èƒ½ä¼šè¢«ä¿å­˜å›¾ç‰‡çš„è¾¹ç¼˜åˆ‡æ‰ï¼Œæ‰€ä»¥ä¸Šé¢è¦ç•™ç™½
    plot.margin = margin(t = 20, r = 10, b = 10, l = 10) 
  ) +
  
  labs(x = "Subtype", y = "Score / Z-score") +

  # --- ğŸ”¥ğŸ”¥ ä¿®æ”¹ç‚¹ 4ï¼šå…³é—­è£å‰ª (Magic Key) ğŸ”¥ğŸ”¥ ---
  # è¿™è¡Œä»£ç å…è®¸ geom_text ç”»åœ¨æ ¼å­å¤–é¢
  coord_cartesian(clip = "off") +

  # --- Copying Test è‡ªå®šä¹‰åæ ‡è½´ (ä¿æŒä¸å˜) ---
  facetted_pos_scales(
    y = list(
      Cognitive_Variable == "Copying Test" ~ scale_y_continuous(
        breaks = c(1, 2, 3), 
        labels = c("Normal", "Mild", "Severe"), 
        limits = c(0.5, 4.5)
      )
    )
  )

print(final_combined_plot)
```

### ä¿å­˜
```{r}
# è®¾ç½®ä¿å­˜ç›®å½•
save_dir <- "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig"

# 1. ä¿å­˜ä¸º PDF
ggsave(
  filename = file.path(save_dir, "Cognitive_Subitems.pdf"),
  plot = final_combined_plot,
  width = 8, 
  height = 6,
  device = cairo_pdf # ä½¿ç”¨ cairo_pdf æ›´å¥½æ”¯æŒç¬¦å·å’Œå­—ä½“
)

# 2. ä¿å­˜ä¸º TIFF (300 dpi, LZW å‹ç¼©)
ggsave(
  filename = file.path(save_dir, "Cognitive_Subitems.tiff"),
  plot = final_combined_plot,
  width = 8, 
  height = 6,
  dpi = 300,
  compression = "lzw", # ä½¿ç”¨æ— æŸå‹ç¼©ï¼Œé˜²æ­¢æ–‡ä»¶è¿‡å¤§
  bg = "white"         # ç¡®ä¿èƒŒæ™¯ä¸æ˜¯é€æ˜çš„
)
```





