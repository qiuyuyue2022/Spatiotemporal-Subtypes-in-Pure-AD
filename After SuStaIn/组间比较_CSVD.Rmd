---
title: "R Notebook"
output: html_notebook
---

# æ•°æ®å‡†å¤‡
```{r}
library(tidyverse)
library(dplyr)
library(readr)
library(FSA)        # Dunn test
library(rstatix)    # tidy é—®æ³•çš„ç»Ÿè®¡
options(scipen = 999)

# è¯»å…¥æ•°æ®
df <- read_csv("/Users/qiuyuyue/Documents/MRI/data/SuStaIn/åŸsustain_result_FINAL_MERGED2.csv")

# ç¡®ä¿ ml_subtype æ˜¯ factor
df$ml_subtype <- factor(df$ml_subtype, levels = c(1,2,3,4))
df <- df %>%
  mutate(
    DWMH_pct = DWMH_v*100 / ICV,
    PWMH_pct = PWMH_v*100 / ICV,
    CMB_pct = CMB_Total_v*100 / ICV,
    PVS_pct = PVS_Total_v*100 / ICV,
    LA_pct = LA_Total_v*100 / ICV
  )

# éœ€è¦æ¯”è¾ƒçš„ biomarkers
csvd <- c("PWMH_pct", "DWMH_pct", "CMB_num", "PVS_num")
df <- df %>%drop_na(all_of(csvd))
print(nrow(df))

```
# ä¸‰é«˜
```{r}
# éœ€è¦æ¯”è¾ƒçš„äºŒåˆ†ç±»å˜é‡
bin_vars <- c("é«˜è¡€å‹", "é«˜è¡€è„‚", "ç³–å°¿ç—…")

# ä¿å­˜ç»“æœ
binary_test_results <- list()

for (var in bin_vars) {
  # åˆ—è”è¡¨
  tab <- table(df$ml_subtype, df[[var]])
  
  # åˆ¤æ–­æ˜¯å¦éœ€è¦ Fisherï¼ˆå¦‚æœä»»æ„ä¸€ä¸ª cell <5ï¼‰
  if (any(tab < 5)) {
    test_res <- fisher.test(tab)
    method <- "Fisher's Exact Test"
  } else {
    test_res <- chisq.test(tab)
    method <- "Chi-square Test"
  }
  
  binary_test_results[[var]] <- list(
    variable = var,
    method = method,
    table = tab,
    p_value = test_res$p.value
  )
}

# æŸ¥çœ‹æ‰€æœ‰ç»“æœ
binary_test_results

```


# KW
```{r}
library(dplyr)
library(tidyr)
library(purrr)

kw_results <- df %>%
  dplyr::select(ml_subtype, all_of(csvd)) %>%
  pivot_longer(cols = all_of(csvd), names_to = "csvd", values_to = "value") %>%
  drop_na(value) %>% # ç¡®ä¿åœ¨è¿›è¡Œç»Ÿè®¡æ£€éªŒå‰ç§»é™¤ NA å€¼
  group_by(csvd) %>%
  summarise(
    # è¿è¡Œæ£€éªŒå¹¶ä¿å­˜å®Œæ•´ç»“æœåˆ—è¡¨
    test_output = list(kruskal.test(value ~ ml_subtype)), 
    .groups = 'drop' # ä¿æŒä»£ç ç®€æ´ï¼Œç›´æ¥è§£ç»„
  ) %>%
  # æå–æ‰€éœ€çš„ç»Ÿè®¡ä¿¡æ¯
  mutate(
    statistic = map_dbl(test_output, ~ .$statistic), # æå– Kruskal-Wallis Ï‡Â² (H) ç»Ÿè®¡é‡
    df = map_dbl(test_output, ~ .$parameter),       # æå–è‡ªç”±åº¦ (df)
    p = map_dbl(test_output, ~ .$p.value)           # æå– P å€¼
  ) %>%
  # è¿›è¡Œ FDR (BH) æ ¡æ­£
  mutate(
    p_adj = p.adjust(p, method = "fdr")
  ) %>%
  # ä»…ä¿ç•™å…³é”®ç»“æœåˆ—
  dplyr::select(csvd, statistic, df, p, p_adj)

print(kw_results)
```



# Dunn
```{r}
sig_csvd <- c("DWMH_pct", "CMB_num", "PVS_num")

dunn_results <- df %>%
  dplyr::select(ml_subtype, all_of(sig_csvd)) %>%
  pivot_longer(cols = sig_csvd, names_to = "csvd", values_to = "value") %>%
  group_by(csvd) %>%
  do(
    FSA::dunnTest(value ~ ml_subtype, data = ., method = "bh")$res
  )%>%
  add_significance("P.adj")

print(dunn_results)
```

# å¯è§†åŒ–
```{r}
library(ggpubr)
library(tidyverse)
library(rstatix)

# 1. æ•°æ®å‡†å¤‡
plot_data <- df %>%
  dplyr::select(ml_subtype, all_of(csvd)) %>%
  pivot_longer(cols = all_of(csvd), names_to = "csvd", values_to = "value") %>%
  mutate(ml_subtype = as.factor(ml_subtype)) %>%
  drop_na()

# 2. 
stat.test <- plot_data %>%
  group_by(csvd) %>%
  group_modify(~ {
    .x %>%
      wilcox_test(value ~ ml_subtype) %>%
      adjust_pvalue(method = "BH") %>%
      add_significance() %>%
      filter(p.adj < 0.05) %>%
      # è¿™é‡Œçš„ step.increase ç°åœ¨åªé’ˆå¯¹å½“å‰çš„ csvd ç”Ÿæ•ˆ
      add_xy_position(x = "ml_subtype", step.increase = 0.05) 
  }) %>%
  ungroup() # è®°å¾—è§£ç»„

# 3. ç»˜å›¾
ggboxplot(plot_data, x = "ml_subtype", y = "value",
          fill = "ml_subtype", palette = "jama",
          add = "jitter",
          facet.by = "csvd", scales = "free_y",
          short.panel.labs = FALSE,
          outlier.shape = NA) + 
  
  # ç»˜åˆ¶æ˜¾è‘—æ€§æ ‡è®°
  stat_pvalue_manual(stat.test, label = "p.adj.signif", 
                     tip.length = 0.01, 
                     hide.ns = TRUE) +
  
  # è°ƒæ•´ Y è½´ç•™ç™½ï¼šé¡¶éƒ¨ç•™ 15% ç©ºé—´ç»™æ˜Ÿå·ï¼Œåº•éƒ¨ç•™ 5%
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
  
  theme_bw() +
  labs(x = "ML Subtype", y = "CSVD")


```
```{r}
library(ggpubr)
library(dplyr)
library(tidyr) 

plot_PWMH <- ggboxplot(df, x = "ml_subtype", y = "PWMH_pct",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_pvalue_manual(
    dunn_results %>% 
      separate(Comparison, into = c("group1", "group2"), sep = " - ", remove = FALSE) %>% 
      filter(csvd == "PWMH_pct") %>%
      filter(P.adj < 0.05) %>%
      mutate(y.position = seq(1.25, by = 0.06, length.out = n())),
    label = "P.adj.signif",
    tip.length = 0.005 # ğŸ‘ˆ é‡ç‚¹ä¿®æ”¹ï¼šæ·»åŠ æ­¤è¡Œæ¥æ§åˆ¶çŸ­ç«–çº¿çš„é•¿åº¦
  ) +
  labs(x = "Subtype", y = "PWMH (%)") +
  theme(legend.position = "none") + 
  ggplot2::coord_cartesian(ylim = c(0, 1.5))

plot_DWMH <- ggboxplot(df, x = "ml_subtype", y = "DWMH_pct",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_pvalue_manual(
    dunn_results %>% 
      separate(Comparison, into = c("group1", "group2"), sep = " - ", remove = FALSE) %>% 
      filter(csvd == "DWMH_pct") %>%
      filter(P.adj < 0.05) %>%
      mutate(y.position = seq(1.25, by = 0.06, length.out = n())),
    label = "P.adj.signif",
    tip.length = 0.005 # ğŸ‘ˆ é‡ç‚¹ä¿®æ”¹ï¼šæ·»åŠ æ­¤è¡Œæ¥æ§åˆ¶çŸ­ç«–çº¿çš„é•¿åº¦
  ) +
  labs(x = "Subtype", y = "DWMH (%)") +
  theme(legend.position = "none") + 
  ggplot2::coord_cartesian(ylim = c(0, 1.5))


plot_CMB <- ggboxplot(df, x = "ml_subtype", y = "CMB_num",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_pvalue_manual(
    dunn_results %>% 
      separate(Comparison, into = c("group1", "group2"), sep = " - ", remove = FALSE) %>% 
      filter(csvd == "CMB_num") %>%
      filter(P.adj < 0.05) %>%
      mutate(y.position = seq(13, by = 0.6, length.out = n())),
    label = "P.adj.signif",
    tip.length = 0.0007 # ğŸ‘ˆ é‡ç‚¹ä¿®æ”¹ï¼šæ·»åŠ æ­¤è¡Œæ¥æ§åˆ¶çŸ­ç«–çº¿çš„é•¿åº¦
  ) +
  labs(x = "Subtype", y = "CMB (n)") +
  theme(legend.position = "none") + 
  ggplot2::coord_cartesian(ylim = c(0, 15))

plot_PVS <- ggboxplot(df, x = "ml_subtype", y = "PVS_num",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_pvalue_manual(
    dunn_results %>% 
      separate(Comparison, into = c("group1", "group2"), sep = " - ", remove = FALSE) %>% 
      filter(csvd == "PVS_num") %>%
      filter(P.adj < 0.05) %>%
      mutate(y.position = seq(610, by = 25, length.out = n())),
    label = "P.adj.signif",
    tip.length = 0.01 # ğŸ‘ˆ é‡ç‚¹ä¿®æ”¹ï¼šæ·»åŠ æ­¤è¡Œæ¥æ§åˆ¶çŸ­ç«–çº¿çš„é•¿åº¦
  ) +
  labs(x = "Subtype", y = "PVS (n)") +
  theme(legend.position = "none") + 
  ggplot2::coord_cartesian(ylim = c(0, 680))

plot_LA <- ggboxplot(df, x = "ml_subtype", y = "LA_num",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_pvalue_manual(
    dunn_results %>% 
      separate(Comparison, into = c("group1", "group2"), sep = " - ", remove = FALSE) %>% 
      filter(csvd == "LA_num") %>%
      filter(P.adj < 0.05) %>%
      mutate(y.position = seq(13, by = 0.6, length.out = n())),
    label = "P.adj.signif",
    tip.length = 0.0007 # ğŸ‘ˆ é‡ç‚¹ä¿®æ”¹ï¼šæ·»åŠ æ­¤è¡Œæ¥æ§åˆ¶çŸ­ç«–çº¿çš„é•¿åº¦
  ) +
  labs(x = "Subtype", y = "LA (n)") +
  theme(legend.position = "none") + 
  ggplot2::coord_cartesian(ylim = c(0, 15))

CSVD_plot <- ggarrange(plot_PWMH, plot_DWMH, plot_CMB, plot_PVS,
          ncol = 2, nrow = 2,
          labels = c("A", "B", "C", "D"))

ggexport(
  CSVD_plot, 
  filename = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/CSVD_plot.pdf", 
  width = 6,  # å›¾åƒå®½åº¦ (è‹±å¯¸)
  height = 6   # å›¾åƒé«˜åº¦ (è‹±å¯¸)
  # PDF æ–‡ä»¶æ˜¯çŸ¢é‡å›¾ï¼Œä¸éœ€è¦è®¾ç½® res å‚æ•°
)
CSVD_plot

```


# ä¸­ä»‹æ•ˆåº”å’Œç»“æ„æ–¹ç¨‹æ¨¡å‹
```{r}
library(mediation)
library(dplyr)

# 1. è¯»å–æ•°æ®
df <- read.csv("/Users/qiuyuyue/Documents/MRI/data/SuStaIn/åŸsustain_result_FINAL_MERGED.csv")

# 2. æ•°æ®é¢„å¤„ç†
# å°† ml_type è½¬æ¢ä¸ºäºŒå€¼å˜é‡ (æ˜¯å¦ä¸º Type 4)
df$is_type4 <- ifelse(df$ml_subtype == 4, 1, 0)

# 1. å®šä¹‰åˆ†ææ‰€éœ€çš„æ‰€æœ‰åˆ—å (è¯·ç¡®ä¿ Age å’Œ Sex åˆ—åæ­£ç¡®)
analysis_vars <- c("DWMH_v", "is_type4", "lumi_Ab42", "age", "sex", "ICV") # æ›¿æ¢ mediator ä¸ºå®é™…å˜é‡å

# 2. ç­›é€‰å‡ºæ‰€éœ€å˜é‡ï¼Œå¹¶åˆ é™¤åŒ…å«ä»»ä½• NA å€¼çš„è¡Œ
df <- df %>%
  filter(if_all(all_of(analysis_vars), ~ !is.na(.x)))
# æ‰§è¡Œæ ‡å‡†åŒ–
vars_to_standardize <- c("DWMH_v", "lumi_Ab42", "lumi_pTau181", "lumi_tTau", "age", "ICV")
df_std <- df %>% mutate(across(all_of(vars_to_standardize), ~ scale(.)[,1]))

head(df_std)
```


# æ¢ç´¢biomarkeræ˜¯å¦éƒ¨åˆ†ä¸­ä»‹äº†Subtype4ä¸­çš„é«˜DWMH
```{r}
library(lavaan)

model_syntax <- '
  # =======================================================
  # è·¯å¾„ A: è‡ªå˜é‡ â†’ ä¸‰ä¸ªä¸­ä»‹
  # =======================================================
  lumi_tTau ~ a1 * is_type4 + age + sex + ICV
  lumi_Ab42 ~ a2 * is_type4 + age + sex + ICV
  lumi_pTau181 ~ a3 * is_type4 + age + sex + ICV

  # =======================================================
  # è·¯å¾„ B å’Œ C_prime: ä¸‰ä¸ªä¸­ä»‹ + è‡ªå˜é‡ â†’ å› å˜é‡
  # =======================================================
  DWMH_v ~ c_prime * is_type4 + 
           b1 * lumi_tTau +
           b2 * lumi_Ab42 +
           b3 * lumi_pTau181 +
           age + sex + ICV

  # =======================================================
  # ä¸‰ä¸ªä¸­ä»‹çš„æ®‹å·®ç›¸å…³
  # =======================================================
  lumi_tTau ~~ lumi_Ab42
  lumi_tTau ~~ lumi_pTau181
  lumi_Ab42 ~~ lumi_pTau181

  # =======================================================
  # å®šä¹‰ä¸‰æ¡é—´æ¥æ•ˆåº”
  # =======================================================
  indirect_tTau    := a1 * b1
  indirect_Ab42    := a2 * b2
  indirect_pTau181 := a3 * b3

  # æ€»é—´æ¥æ•ˆåº”
  total_indirect := indirect_tTau + indirect_Ab42 + indirect_pTau181

  # æ€»æ•ˆåº”
  total_effect := c_prime + total_indirect
'

# æ‹Ÿåˆæ¨¡å‹
fit <- sem(
  model_syntax,
  data = df_std,
  se = "bootstrap",
  bootstrap = 1000
)

summary(fit, standardized = TRUE, fit.measures = TRUE, ci = TRUE)

```




```{r}
# 1. å®‰è£…å¹¶åŠ è½½ä¸“ç”¨ç»˜å›¾åŒ…
if(!require(diagram)) install.packages("diagram")
library(diagram)

# 2. è®¾ç½®ç”»å¸ƒä¿å­˜ (å¯é€‰: å¦‚æœæƒ³ç›´æ¥ä¿å­˜ä¸ºPDFï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š)
# pdf("Figure_Mediation_Final.pdf", width = 8, height = 6)

# 3. å‡†å¤‡ç»˜å›¾å‚æ•°
par(mar = c(1, 1, 1, 1)) # å‡å°‘é¡µè¾¹è·
openplotmat() # åˆå§‹åŒ–ç”»å¸ƒ

# --- å®šä¹‰èŠ‚ç‚¹ä½ç½® (åæ ‡ 0-1 ä¹‹é—´) ---
# å¸ƒå±€ï¼šå·¦(è‡ªå˜é‡), ä¸­(ä¸‰ä¸ªä¸­ä»‹), å³(å› å˜é‡)
pos_X    <- c(0.15, 0.5)  # Type 4
pos_Y    <- c(0.85, 0.5)  # DWMH
pos_M_up <- c(0.50, 0.8)  # t-Tau (ä¸Š)
pos_M_mi <- c(0.50, 0.5)  # Abeta42 (ä¸­ - æ ¸å¿ƒ)
pos_M_dn <- c(0.50, 0.2)  # p-Tau181 (ä¸‹)

# --- å®šä¹‰å˜é‡æ–‡å­— ---
# è¿™é‡Œå¯ä»¥ç›´æ¥æ”¹åï¼Œæ¯”å¦‚åŠ ä¸Šå•ä½
lab_X <- "ML Subtype 4"
lab_Y <- "DWMH Volume"
lab_M_up <- "Plasma t-Tau"
lab_M_mi <- "Plasma A\u03b242" # \u03b2 æ˜¯ beta ç¬¦å·
lab_M_dn <- "Plasma p-Tau181"

# --- ç»˜åˆ¶çŸ©å½¢æ¡† ---
# æ ¸å¿ƒæ˜¾è‘—å˜é‡ç”¨å®çº¿æ¡†ï¼Œéæ˜¾è‘—ç”¨è™šçº¿æˆ–æ™®é€šæ¡†
textrect(mid = pos_X, radx = 0.1, rady = 0.05, lab = lab_X, shadow.size = 0, box.col = "white", cex = 1.2)
textrect(mid = pos_Y, radx = 0.1, rady = 0.05, lab = lab_Y, shadow.size = 0, box.col = "white", cex = 1.2)
textrect(mid = pos_M_up, radx = 0.1, rady = 0.05, lab = lab_M_up, shadow.size = 0, box.col = "white", lty = 2, cex = 1) # è™šçº¿æ¡†è¡¨ç¤ºéæ˜¾è‘—ä¸­ä»‹
textrect(mid = pos_M_mi, radx = 0.1, rady = 0.05, lab = lab_M_mi, shadow.size = 0, box.col = "#E6E6FA", cex = 1.2) # æ·¡ç´«è‰²åº•è‰²çªå‡ºæ˜¾è‘—ä¸­ä»‹
textrect(mid = pos_M_dn, radx = 0.1, rady = 0.05, lab = lab_M_dn, shadow.size = 0, box.col = "white", lty = 2, cex = 1)

# --- ç»˜åˆ¶ç®­å¤´ä¸ç³»æ•° (æ ¸å¿ƒéƒ¨åˆ†) ---
# ä½¿ç”¨ straightarrow (ç›´çº¿) æˆ– curvedarrow (æ›²çº¿)

# 1. æ˜¾è‘—è·¯å¾„ï¼šType 4 -> Abeta42 (Path a)
straightarrow(from = pos_X, to = pos_M_mi, lcol = "black", lwd = 2, arr.pos = 0.5, arr.length = 0.25)
text(0.32, 0.52, labels = "-0.813***", cex = 1, font = 2) # æ‰‹åŠ¨è°ƒæ•´ä½ç½®ç¡®ä¿ä¸é‡å 

# 2. æ˜¾è‘—è·¯å¾„ï¼šAbeta42 -> DWMH (Path b)
straightarrow(from = pos_M_mi, to = pos_Y, lcol = "black", lwd = 2, arr.pos = 0.5, arr.length = 0.25)
text(0.68, 0.52, labels = "-0.171*", cex = 1, font = 2)

# 3. æ˜¾è‘—è·¯å¾„ï¼šç›´æ¥æ•ˆåº” (Path c') - ç”»ä¸€æ¡æ›²çº¿ç»•å¼€ä¸­é—´
curvedarrow(from = pos_X, to = pos_Y, curve = -0.3, lcol = "black", lwd = 2, arr.pos = 0.5, lty = 1)
text(0.5, 0.25, labels = "Direct Effect: 1.205**", cex = 1, font = 2) # æ”¾åœ¨æ›²çº¿ä¸‹æ–¹

# --- ç»˜åˆ¶ä¸æ˜¾è‘—è·¯å¾„ (è™šçº¿) ---
# Type 4 -> t-Tau
straightarrow(from = pos_X, to = pos_M_up, lcol = "gray", lwd = 1, lty = 2, arr.pos = 0.6)
# Type 4 -> p-Tau
straightarrow(from = pos_X, to = pos_M_dn, lcol = "gray", lwd = 1, lty = 2, arr.pos = 0.6)
# t-Tau -> DWMH
straightarrow(from = pos_M_up, to = pos_Y, lcol = "gray", lwd = 1, lty = 2, arr.pos = 0.4)
# p-Tau -> DWMH
straightarrow(from = pos_M_dn, to = pos_Y, lcol = "gray", lwd = 1, lty = 2, arr.pos = 0.4)

# --- æ·»åŠ å›¾æ³¨ä¿¡æ¯ ---
text(0.5, 0.1, "Indirect Effect via A\u03b242: 0.139*", cex = 1.1, font = 2)
text(0.5, 0.05, "Adjusted for Age, Sex, ICV", cex = 0.8, col = "gray40")

# å¦‚æœä¹‹å‰ä½¿ç”¨äº†pdf()ï¼Œè®°å¾—å…³é—­
# dev.off()
```



```{r}
# å®šä¹‰å˜é‡å (æ ¹æ®æ‚¨å®é™…çš„åˆ—åä¿®æ”¹ Age å’Œ Sex)
mediator <- "lumi_Ab42"      # ä¸­ä»‹å˜é‡ M
outcome <- "DWMH_v"          # å› å˜é‡ Y
treatment <- "is_type4"      # è‡ªå˜é‡ X
covariates <- "age + sex + ICV"    # åå˜é‡

# --- åˆ†ææ­¥éª¤ ---
# Step 1: æ¨¡å‹ M (Mediator model): X -> M
# æ£€éªŒ Type 4 å¯¹ Biomarker çš„å½±å“ (æ§åˆ¶å¹´é¾„æ€§åˆ«)
f_med <- as.formula(paste(mediator, "~", treatment, "+", covariates))
model_m <- lm(f_med, data = df_std)

# Step 2: æ¨¡å‹ Y (Outcome model): X + M -> Y
# æ£€éªŒ Biomarker å¯¹ DWMH çš„å½±å“ (æ§åˆ¶ Type 4 å’Œå¹´é¾„æ€§åˆ«)
f_out <- as.formula(paste(outcome, "~", treatment, "+", mediator, "+", covariates))
model_y <- lm(f_out, data = df_std)

# Step 3: è¿è¡Œä¸­ä»‹åˆ†æ (ä½¿ç”¨ Bootstrap æ–¹æ³•ï¼Œé‡å¤ 1000 æ¬¡)
# è¿™æ˜¯ R çš„æ€æ‰‹é”ï¼Œè‡ªåŠ¨è®¡ç®— ACME å’Œç½®ä¿¡åŒºé—´
results <- mediate(model_m, model_y, treat = treatment, mediator = mediator, boot = TRUE, sims = 1000)

# 4. æŸ¥çœ‹ç»“æœ
summary(results)
```










