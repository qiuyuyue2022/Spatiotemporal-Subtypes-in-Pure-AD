---
title: "R Notebook"
output: html_notebook
---

# åŠ è½½åŒ…
```{r}
rm(list = ls())
library(readxl)
library(dplyr)
library(lubridate)
library(openxlsx)
library(tidyr)
library(ggpubr)
library(rstatix)
library(tibble)
options(scipen = 999)
```

# è¯»å–è¡¨å’Œå˜é‡
```{r}
# è¯»å–è¡¨
df <- read.csv("/Users/qiuyuyue/Documents/MRI/data/SuStaIn/åŸsustain_result_FINAL_MERGED.csv") %>%
  mutate(ID = as.character(ID), 
         mri_date = as.Date(mri_date))
df <- df %>%
  mutate(
    # å¦‚æœ AOO åˆ—ä¸º NAï¼Œåˆ™ä½¿ç”¨ age åˆ—çš„å€¼å¡«å……ï¼›
    # å¦‚æœ AOO ä¸ä¸º NAï¼Œåˆ™ä¿ç•™ AOO åŸå§‹å€¼ã€‚
    AOO = coalesce(AOO, age)
  )

df <- df[df$ml_subtype != 0, ]
df$ml_subtype <- as.factor(df$ml_subtype)

df$age <- gsub("Y", "", df$age)
df$age <- as.numeric(df$age)
df$apoe4 <- as.numeric(df$apoe4)
df$apoe4_num <- as.numeric(df$apoe4_num)
df$sex <- as.factor(df$sex)
table(df$ml_subtype)
shapiro.test(df$age)
shapiro.test(df$AOO)
shapiro.test(df$ml_stage)

cont_vars <- c("age","AOO", "edu_year", "mmse", "adl")
cat_vars <- c("sex", "apoe4")
```

# è®¡ç®—æ¯ç»„æ ·æœ¬é‡
```{r}
subtype_counts <- df %>%
  count(ml_subtype) %>%
  arrange(as.numeric(as.character(ml_subtype))) %>%
  mutate(label = paste0("Subtype ", ml_subtype, "\n(n = ", n, ")"))
subtype_counts
```
# è¿ç»­å˜é‡ï¼šä¸­ä½æ•° [IQR]ï¼Œè½¬å®½æ•°æ®
```{r}
cont_summary <- df %>%
  group_by(ml_subtype) %>%
  summarise(across(all_of(cont_vars), list(
    median = ~median(., na.rm = TRUE),
    Q1 = ~quantile(., 0.25, na.rm = TRUE),
    Q3 = ~quantile(., 0.75, na.rm = TRUE)
  ), .names = "{.col}_{.fn}")) %>%
  ungroup() %>%
  mutate(across(ends_with("_median"), ~round(., 2)),
         across(ends_with("_Q1"), ~round(., 2)),
         across(ends_with("_Q3"), ~round(., 2))) %>%
  mutate(
    age      = paste0(age_median, " [", age_Q1, "-", age_Q3, "]"),
    AOO      = paste0(AOO_median, " [", AOO_Q1, "-", AOO_Q3, "]"),
    edu_year = paste0(edu_year_median, " [", edu_year_Q1, "-", edu_year_Q3, "]"),
    MMSE     = paste0(mmse_median, " [", mmse_Q1, "-", mmse_Q3, "]"),
    ADL      = paste0(adl_median, " [", adl_Q1, "-", adl_Q3, "]")
  ) %>%
  select(ml_subtype, age, AOO, edu_year, MMSE, ADL) %>%
  pivot_longer(cols = -ml_subtype, names_to = "Variable", values_to = "Value") %>%
  pivot_wider(names_from = ml_subtype, values_from = Value)
cont_total_col <- df %>%
  summarise(across(all_of(cont_vars), list(
    median = ~median(., na.rm = TRUE),
    Q1 = ~quantile(., 0.25, na.rm = TRUE),
    Q3 = ~quantile(., 0.75, na.rm = TRUE)
  ), .names = "{.col}_{.fn}")) %>%
  mutate(across(ends_with("_median"), ~round(., 2)),
         across(ends_with("_Q1"), ~round(., 2)),
         across(ends_with("_Q3"), ~round(., 2))) %>%
  mutate(
    age      = paste0(age_median, " [", age_Q1, "-", age_Q3, "]"),
    AOO      = paste0(AOO_median, " [", AOO_Q1, "-", AOO_Q3, "]"),
    edu_year = paste0(edu_year_median, " [", edu_year_Q1, "-", edu_year_Q3, "]"),
    MMSE     = paste0(mmse_median, " [", mmse_Q1, "-", mmse_Q3, "]"),
    ADL      = paste0(adl_median, " [", adl_Q1, "-", adl_Q3, "]")
  ) %>%
  select(age, AOO, edu_year, MMSE, ADL) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Total")
cont_summary
```
# åˆ†ç±»å˜é‡
```{r}
sex_summary <- df %>%
  group_by(ml_subtype, sex) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ml_subtype) %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  mutate(sex_label = ifelse(sex == "0", "Female", "Male"),
         val = paste0(n, " (", percent, "%)")) %>%
  filter(sex == "0") %>%  # åªä¿ç•™ Female è¡Œ
  select(ml_subtype, sex_label, val) %>%
  pivot_wider(names_from = ml_subtype, values_from = val) %>%
  rename(Variable = sex_label)
sex_total_col <- df %>%
  group_by(sex) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  mutate(sex_label = ifelse(sex == "0", "Female", "Male"),
         Total = paste0(n, " (", percent, "%)")) %>%
  filter(sex == "0") %>%
  select(sex_label, Total) %>%
  rename(Variable = sex_label)
# å¤„ç† APOE Îµ4 carrier / non-carrier
apoe_summary <- df %>%
  filter(!is.na(apoe4)) %>%  # å»é™¤ NA è¡Œï¼Œä¿è¯åˆ†æ¯å‡†ç¡®
  group_by(ml_subtype, apoe4) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(apoe4 = as.character(apoe4)) %>%
  mutate(carrier_status = case_when(
    apoe4 == "1" ~ "carrier",
    apoe4 == "0" ~ "non-carrier"
  )) %>%
  select(ml_subtype, carrier_status, n) %>%
  pivot_wider(names_from = carrier_status, values_from = n, values_fill = 0) %>%
  mutate(val = paste0(carrier, " / ", `non-carrier`)) %>%
  select(ml_subtype, val) %>%
  pivot_wider(names_from = ml_subtype, values_from = val) %>%
  mutate(Variable = "APOE Îµ4 carrier / non-carrier") %>%
  select(Variable, everything())
apoe_total_col <- df %>%
  filter(!is.na(apoe4)) %>%
  group_by(apoe4) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(apoe4 = as.character(apoe4)) %>%
  mutate(carrier_status = case_when(
    apoe4 == "1" ~ "carrier",
    apoe4 == "0" ~ "non-carrier"
  )) %>%
  select(carrier_status, n) %>%
  pivot_wider(names_from = carrier_status, values_from = n, values_fill = 0) %>%
  mutate(Total = paste0(carrier, " / ", `non-carrier`),
         Variable = "APOE Îµ4 carrier / non-carrier") %>%
  select(Variable, Total)
# 4. åˆå¹¶è¿ç»­å’Œåˆ†ç±»å˜é‡
# åˆå¹¶ Subtype 1-4 çš„ summary
summary_final_orig <- bind_rows(cont_summary, sex_summary, apoe_summary)
# åˆå¹¶ Total åˆ—
total_summary_col <- bind_rows(cont_total_col, sex_total_col, apoe_total_col)

# æ•´åˆ Total åˆ—åˆ° summary_final_orig
summary_final <- summary_final_orig %>%
  left_join(total_summary_col, by = "Variable") %>%
  # å°† Total åˆ—ç§»åŠ¨åˆ° Subtype åˆ—ä¹‹å‰
  relocate(Total, .after = Variable)
summary_final
```


# ä¿®æ”¹è¡¨æ ¼æ ¼å¼
```{r}
total_n <- sum(subtype_counts$n)
colnames(summary_final) <- c(
  "Variable",
  paste0("Total (n = ", total_n, ")"), # Total åˆ—çš„æ ‡é¢˜
  subtype_counts$label
)

desired_order <- c(
  "age",
  "AOO",
  "Female",
  "edu_year",
  "APOE Îµ4 carrier / non-carrier",
  "MMSE",
  "ADL"
)

summary_final <- summary_final %>%
  mutate(Variable = factor(Variable, levels = desired_order)) %>%
  arrange(Variable)

summary_final
```

# på€¼
```{r}
# 1. Kruskal-Wallisï¼šä¸åšæ ¡æ­£
kw_results <- df %>%
  select(ml_subtype, age, AOO, edu_year, mmse, adl) %>%
  pivot_longer(cols = -ml_subtype, names_to = "Variable", values_to = "Value") %>%
  group_by(Variable) %>%
  summarise(
    Statistic = kruskal.test(Value ~ ml_subtype)$statistic,
    P_value = kruskal.test(Value ~ ml_subtype)$p.value
  )

# 2. æ€§åˆ«å¡æ–¹ï¼šä¸åšæ ¡æ­£
tbl_sex <- table(df$sex, df$ml_subtype)
chi_sex <- chisq.test(tbl_sex)
fisher_sex <- fisher.test(tbl_sex)
sex_result <- data.frame(
  Variable = "sex",
  P_value = chi_sex$p.value
)

# 2. apoe4å¡æ–¹ï¼šä¸åšæ ¡æ­£
tbl_apoe4 <- table(df$apoe4, df$ml_subtype)
chi_apoe4 <- chisq.test(tbl_apoe4)
fisher_apoe4 <- fisher.test(tbl_apoe4)
apoe4_result <- data.frame(
  Variable = "apoe4",
  P_value = chi_apoe4$p.value
)

# 3. åˆå¹¶åç»Ÿä¸€ FDR æ ¡æ­£
all_results <- bind_rows(kw_results, sex_result, apoe4_result) %>%
  mutate(FDR_P = p.adjust(P_value, method = "fdr"))

# 4. è¾“å‡ºç»“æœ
all_results_formatted <- all_results %>%
  slice(match(c("age", "AOO", "sex", "edu_year", "apoe4", "mmse", "adl"), Variable))  %>%
  mutate(
    P_value = round(P_value, 4),
    FDR_P   = round(FDR_P, 4),
    Statistic = round(Statistic, 2)  # å¦‚æœä½ æƒ³æ§åˆ¶ç»Ÿè®¡é‡ä¿ç•™ä¸¤ä½
  )

print(all_results_formatted)
```

# Dunnç»„é—´æ¯”è¾ƒ
```{r}
# å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—æ•°æ®ã€å› å˜é‡åç§°å’Œåˆ†ç»„å˜é‡åç§°
perform_dunn_summary <- function(data, dependent_var, group_var = "ml_subtype") {
  
  # 1ï¸âƒ£ è®¡ç®— Dunn æ£€éªŒ + FDR
  dunn_result <- data %>%
    rstatix::dunn_test(as.formula(paste(dependent_var, "~", group_var)), p.adjust.method = "fdr") %>%
    mutate(
      group1 = as.character(group1),
      group2 = as.character(group2)
    )
  
  # 2ï¸âƒ£ è®¡ç®—å„ç»„ä¸­ä½æ•°å’Œ IQR
  summary_result <- data %>%
    group_by(!!sym(group_var)) %>%
    summarise(
      median_val = median(!!sym(dependent_var), na.rm = TRUE),
      Q1 = quantile(!!sym(dependent_var), 0.25, na.rm = TRUE),
      Q3 = quantile(!!sym(dependent_var), 0.75, na.rm = TRUE),
      IQR_str = paste0("[", round(Q1, 1), "â€“", round(Q3, 1), "]"),
      .groups = "drop"
    )
  
  # 3ï¸âƒ£ åˆå¹¶ Dunn ç»“æœå’Œä¸­ä½æ•°/IQR
  final_result <- dunn_result %>%
    left_join(summary_result, by = c("group1" = group_var)) %>%
    rename(group1_median = median_val, group1_IQR = IQR_str) %>%
    left_join(summary_result, by = c("group2" = group_var)) %>%
    rename(group2_median = median_val, group2_IQR = IQR_str) %>%
    select(.y., group1, group2, n1, n2,
           group1_median, group1_IQR,
           group2_median, group2_IQR,
           p, p.adj, p.adj.signif)
  
  return(final_result)
}

# åº”ç”¨å‡½æ•°
age_dunn_final <- perform_dunn_summary(df, "age")
AOO_dunn_final <- perform_dunn_summary(df, "AOO")

age_dunn_final
AOO_dunn_final
```

# å¯è§†åŒ–
```{r}
library(ggpubr)
library(dplyr)
library(Cairo)

# 1. Age ç®±çº¿å›¾ (å®å¿ƒå¡«å…… + æ¶¦è‰²)
plot_age <- ggboxplot(df, x = "ml_subtype", y = "age",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",         # ä½¿ç”¨ jama é…è‰²
                      alpha = 0.8,              # ğŸ‘ˆ 0.8 ä¸é€æ˜åº¦ï¼Œçœ‹èµ·æ¥æ›´æœ‰è´¨æ„Ÿ
                      add = "jitter",           # æ·»åŠ æ•£ç‚¹
                      add.params = list(size = 1.5, alpha = 0.6), # è°ƒæ•´æ•£ç‚¹å¤§å°å’Œé€æ˜åº¦
                      outlier.shape = NA) +     # ğŸ‘ˆ éšè—ç®±çº¿å›¾è‡ªå¸¦çš„ç¦»ç¾¤ç‚¹ï¼Œé¿å…ä¸ jitter é‡å¤
  stat_compare_means(method = "kruskal.test", label.y = max(df$age, na.rm = TRUE) + 7,
                     size = 3.5,                # å­—ä½“å¤§å°è®¾ç½®ä¸º 3.5
                     fontface = "italic") +
  stat_pvalue_manual(
    age_dunn_final %>% filter(p.adj < 0.05) %>%
      mutate(y.position = seq(max(df$age, na.rm = TRUE) + 1, by = 1, length.out = n())),
    label = "p.adj.signif"
  ) +
  labs(x = "Subtype", y = "Age") +
  theme(legend.position = "none")

# 2. AOO ç®±çº¿å›¾ (å®å¿ƒå¡«å…… + æ¶¦è‰²)
plot_AOO <- ggboxplot(df, x = "ml_subtype", y = "AOO",
                      fill = "ml_subtype",      # ğŸ‘ˆ ä¿®æ”¹è¿™é‡Œï¼šç”¨ fill å¡«å……é¢œè‰²
                      palette = "jama",
                      alpha = 0.8,
                      add = "jitter",
                      add.params = list(size = 1.5, alpha = 0.6),
                      outlier.shape = NA) +
  stat_compare_means(method = "kruskal.test", label.y = max(df$AOO, na.rm = TRUE) + 7,
                     size = 3.5,                # å­—ä½“å¤§å°è®¾ç½®ä¸º 3.5
                     fontface = "italic") +
  stat_pvalue_manual(
    AOO_dunn_final %>% filter(p.adj < 0.05) %>%
      mutate(y.position = seq(max(df$AOO, na.rm = TRUE) + 1, by = 1, length.out = n())),
    label = "p.adj.signif"
  ) +
  labs(x = "Subtype", y = "AOO (Age of Onset)") +
  theme(legend.position = "none")

plot_apoe <- ggplot(df, aes(x = ml_subtype, fill = as.factor(apoe4_num))) +
  geom_bar(position = "fill") +
  scale_fill_brewer(palette = "Blues", name = expression("APOE"*epsilon*"4 count")) +
  labs(x = "Subtype", y = "Proportion") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal() +
  theme(legend.title = element_text(size = 10))

# 3. åˆå¹¶å›¾å½¢
combined_plot <- ggarrange(plot_age, plot_AOO, plot_apoe, 
          ncol = 3, nrow = 1,
          labels = c("A", "B", "C"),
          widths = c(1, 1, 1.3))

# ä½¿ç”¨ ggexport ä¿å­˜å›¾ç‰‡ä¸º PDF
ggexport(
  plot_age,
  filename = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/Age_Boxplot.pdf",
  width = 3.5, # è°ƒæ•´å®½åº¦ä»¥é€‚åº”å•ä¸ªå›¾
  height = 4 
)

ggexport(
  plot_AOO,
  filename = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/AOO_Boxplot.pdf",
  width = 3.5, # è°ƒæ•´å®½åº¦ä»¥é€‚åº”å•ä¸ªå›¾
  height = 4
)

ggexport(
  plot_apoe,
  filename = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/apoe_Boxplot.pdf",
  width = 4.6, # è°ƒæ•´å®½åº¦ä»¥é€‚åº”å•ä¸ªå›¾
  height = 4,
  device = "cairo_pdf"
)

ggexport(
  combined_plot, 
  filename = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/Age_AOO_Boxplot.pdf", 
  width = 11.5,  # å›¾åƒå®½åº¦ (è‹±å¯¸)
  height = 4,   # å›¾åƒé«˜åº¦ (è‹±å¯¸)
  device = "cairo_pdf"
)
combined_plot
```

# ä¸Šä¸‹å·¦å³æ‹¼æ¥
```{r}
# ç¡®ä¿ library(magick) å·²ç»è¿è¡Œ
library(magick)

# 1. å®šä¹‰æ‰€æœ‰æ–‡ä»¶è·¯å¾„
path_ABC <- "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/Age_AOO_Boxplot.pdf"
path_D <- "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/diamond_plots_3d.pdf"
path_E <- "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/MMSEandStage.pdf"

# ----------------- å‡†å¤‡å·¦ä¾§åˆ— (A+B+C å‚ç›´å †å  D) -----------------

# 2. è¯»å–å¹¶å‡†å¤‡ç¬¬ä¸€ä¸ª PDF (A+B+Cå›¾)
img_ABC <- image_read_pdf(path_ABC, density = 300)
img_ABC <- image_border(img_ABC, "white", "10x10") # å¢åŠ è¾¹æ¡†

# 3. è¯»å–å¹¶å‡†å¤‡ç¬¬äºŒä¸ª PDF (Då›¾)
img_D <- image_read_pdf(path_D, density = 300)
img_D <- image_scale(img_D, "80%")

# 4. æ ‡æ³¨ "D"
img_D_labeled <- image_annotate(img_D, "D",
                                gravity = "northwest",
                                size = 17,
                                font = "sans",
                                weight = 400,
                                color = "black",
                                location = "+30+30")

# 5. å‚ç›´æ‹¼æ¥å·¦ä¾§åˆ—
img_column_left <- image_append(c(img_ABC, img_D_labeled), stack = TRUE)
full_height <- image_info(img_column_left)$height # è·å–å·¦ä¾§åˆ—çš„æ€»é«˜åº¦ï¼Œä½œä¸ºå³ä¾§ç”»å¸ƒçš„åŸºå‡†é«˜åº¦

# ----------------- å‡†å¤‡å³ä¾§åˆ— (å›¾ E: ç¼©æ”¾å¹¶å±…ä¸­) -----------------

# 6. è¯»å–å¹¶å‡†å¤‡ç¬¬ä¸‰ä¸ª PDF (æ–°å›¾ E)
img_E <- image_read_pdf(path_E, density = 300)
img_E <- image_trim(img_E) # <--- å…³é”®ä¿®æ”¹ï¼šè£å‰ª PDF å›ºæœ‰çš„å¤šä½™ç™½è¾¹ (å‡å°é—´è·)
img_E <- image_border(img_E, "white", "10x10") # å¢åŠ è¾¹æ¡†

# 7. æ ‡æ³¨ "E"
img_E_labeled <- image_annotate(img_E, "E",
                                gravity = "northwest",
                                size = 14.5,
                                font = "sans",
                                weight = 400,
                                color = "black",
                                location = "+10+5")

# 8. è°ƒæ•´å›¾ E çš„å¤§å°
scale_factor_E <- 0.80
target_E_height <- full_height * scale_factor_E
img_E_scaled <- image_scale(img_E_labeled, paste0("x", target_E_height))
E_current_width <- image_info(img_E_scaled)$width
E_current_height <- image_info(img_E_scaled)$height

# 9. å‚ç›´å±…ä¸­å›¾ E **å¹¶å‘ä¸Šå¾®è°ƒ (ä½¿ç”¨ image_composite ä¿®å¤)**
# 9a. è®¡ç®—å±…ä¸­ç‚¹å’Œåç§»é‡
# ä¸¥æ ¼å±…ä¸­çš„ Y åæ ‡èµ·ç‚¹ (è·ç¦»é¡¶éƒ¨)
center_y_start <- (full_height - E_current_height) / 2

# å‘ä¸Šç§»åŠ¨ 30 åƒç´  (è´Ÿå€¼è¡¨ç¤ºå‘ä¸Šï¼Œæ‰€ä»¥ä»èµ·ç‚¹å‡å» 30)
vertical_adjustment <- 40 # å‘ä¸Šç§»åŠ¨ 30 åƒç´ 
final_y_start <- center_y_start - vertical_adjustment

# 9b. åˆ›å»ºä¸€ä¸ªç­‰é«˜å®½åº¦çš„ç©ºç™½ç”»å¸ƒ
# å®½åº¦å¯ä»¥è®¾ç½®ä¸º E_current_widthï¼Œæˆ–è€…å¦‚æœæƒ³è®© E æ‰€åœ¨åˆ—å’Œå·¦åˆ—å®½åº¦ä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨ full_width_left
# è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ E_current_width æ¥ä¿è¯å›¾åƒç´§å‡‘
canvas <- image_blank(width = E_current_width, height = full_height, color = "white")

# 9c. ä½¿ç”¨ image_composite å°† E å›¾ç²¾ç¡®å åŠ åˆ°ç”»å¸ƒä¸Š
# offset æ ¼å¼ä¸º "+X+Y"ï¼ŒX åç§»ä¸º 0ï¼ŒY åç§»ä¸º final_y_start
img_E_centered <- image_composite(
    canvas,
    img_E_scaled,
    offset = paste0("+0+", round(final_y_start)) # Y åæ ‡ä½¿ç”¨è®¡ç®—å‡ºçš„ç²¾ç¡®å€¼
)

# ----------------- æœ€ç»ˆæ°´å¹³æ‹¼æ¥ (å‡å°é—´è·) -----------------

# 10. æ°´å¹³æ‹¼æ¥å·¦å³ä¸¤åˆ—
combined_final_img <- image_append(c(img_column_left, img_E_centered))
# 11. ä¿å­˜æœ€ç»ˆç»“æœ
image_write(combined_final_img, path = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/Fig2_ABCDE.pdf", format = "pdf")
image_write(
  combined_final_img, 
  path = "/Users/qiuyuyue/Documents/MyPapers/sustain/Fig/Fig2_ABCDE.tiff", 
  format = "tiff", 
  # dpi åœ¨è¿™é‡Œä¸èƒ½è®¾ç½®ï¼Œå®ƒå·²ç»åœ¨ image_read æˆ– image_annotate ç­‰æ“ä½œæ—¶è¢«å¯¹è±¡ç»§æ‰¿
  compression = "lzw" 
)

cat("æœ€ç»ˆåˆå¹¶çš„ PDF/TIFFï¼ˆå·¦ä¾§ A+B+C+D å †å  | å³ä¾§ ç¼©æ”¾å±…ä¸­ Eï¼‰å·²æˆåŠŸä¿å­˜")
```


